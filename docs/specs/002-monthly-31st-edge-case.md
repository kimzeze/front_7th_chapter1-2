# 작업 002: 31일 매월 반복 엣지 케이스 처리

## 1. 개요

### 목적

매월 반복 일정에서 31일을 선택했을 때, 31일이 없는 달(2월, 4월, 6월, 9월, 11월)을 건너뛰고 31일이 있는 달에만 일정을 생성하도록 한다.

### 사용자 시나리오

1. 사용자가 1월 31일에 "매월" 반복 일정을 생성
2. 2월은 28/29일까지만 있으므로 → **2월 건너뜀**
3. 3월 31일 생성
4. 4월은 30일까지만 있으므로 → **4월 건너뜀**
5. 5월 31일 생성
6. 이런 식으로 31일이 있는 달에만 생성

### 배경

작업 001에서 구현한 `getNextOccurrence()` 함수는 단순히 `setMonth(month + 1)`을 사용하므로, 1월 31일에 +1달을 하면 자동으로 2월 28일(또는 29일)이 됩니다. 이는 의도와 다릅니다.

**현재 동작 (잘못됨)**:
```
1월 31일 → 2월 28일 → 3월 28일 → 4월 28일 ...
```

**원하는 동작**:
```
1월 31일 → (2월 건너뜀) → 3월 31일 → (4월 건너뜀) → 5월 31일 ...
```

---

## 2. 요구사항

### 2.1 기능 요구사항

- [ ] 매월 반복에서 시작일이 29~31일인 경우, 해당 날짜가 없는 달은 건너뛴다
- [ ] 31일: 2월, 4월, 6월, 9월, 11월 건너뛰기
- [ ] 30일: 2월 건너뛰기
- [ ] 29일: 평년 2월 건너뛰기 (윤년은 포함)
- [ ] 건너뛴 달은 생성된 이벤트 배열에 포함되지 않는다
- [ ] 다른 반복 유형(daily, weekly, yearly)에는 영향을 주지 않는다

### 2.2 비기능 요구사항

- **기존 테스트 유지**: 작업 001의 17개 테스트는 여전히 통과해야 함
- **성능**: 추가 검증 로직으로 인한 성능 저하 최소화

---

## 3. 영향 범위

### 3.1 수정이 필요한 파일

- `src/utils/recurringEventUtils.ts`
  - `getNextOccurrence()` 함수 수정 (monthly 케이스)
  - 또는 `generateRecurringEvents()` 함수에서 필터링

### 3.2 새로 생성할 파일

- 없음

---

## 4. 구현 방법

### 방법 1: getNextOccurrence()에서 검증 (권장)

```typescript
case 'monthly': {
  const next = new Date(currentDate);
  const originalDay = currentDate.getDate();

  next.setMonth(next.getMonth() + 1);

  // 날짜가 변경되었다면 (예: 31일 → 28일) 건너뛰기
  if (next.getDate() !== originalDay) {
    // 다음 달로 이동하고 원래 날짜로 설정
    next.setDate(1);
    next.setMonth(next.getMonth() + 1);
    next.setDate(0); // 이전 달의 마지막 날

    // 여전히 원래 날짜가 아니면 재귀적으로 다시 시도
    if (next.getDate() !== originalDay) {
      return getNextOccurrence(next, 'monthly');
    }
  }

  return next;
}
```

### 방법 2: generateRecurringEvents()에서 필터링

```typescript
while (currentDate <= effectiveEndDate) {
  const eventDate = formatDate(currentDate);

  // 매월 반복일 때만 날짜 검증
  if (repeat.type === 'monthly') {
    const startDay = new Date(baseEvent.date).getDate();
    const currentDay = currentDate.getDate();

    // 시작일과 현재일이 다르면 건너뛰기
    if (startDay !== currentDay) {
      currentDate = getNextOccurrence(currentDate, repeat.type);
      continue;
    }
  }

  events.push({ ... });
  currentDate = getNextOccurrence(currentDate, repeat.type);
}
```

**선택**: **방법 1**을 사용 (getNextOccurrence에서 처리)
- 이유: 책임 분리 (getNextOccurrence가 "올바른 다음 날짜"를 반환)
- generateRecurringEvents는 단순히 반복만 수행

---

## 5. 알고리즘

### 31일이 있는 달 vs 없는 달

| 월 | 일수 | 31일 존재? |
|----|------|-----------|
| 1월 | 31 | ✅ |
| 2월 | 28/29 | ❌ |
| 3월 | 31 | ✅ |
| 4월 | 30 | ❌ |
| 5월 | 31 | ✅ |
| 6월 | 30 | ❌ |
| 7월 | 31 | ✅ |
| 8월 | 31 | ✅ |
| 9월 | 30 | ❌ |
| 10월 | 31 | ✅ |
| 11월 | 30 | ❌ |
| 12월 | 31 | ✅ |

### 로직

```
1. currentDate = 2025-01-31
2. next.setMonth(1 + 1) = 2025-02-28 (JavaScript 자동 조정)
3. 원래 날짜(31) != 현재 날짜(28) → 건너뛰기 필요
4. 다음 유효한 날짜를 찾을 때까지 반복
5. 2025-03-31 반환
```

---

## 6. 엣지 케이스

### 6.1 31일 매월 반복

- **입력**: 2025-01-31, monthly, endDate: 2025-12-31
- **출력**: 1월, 3월, 5월, 7월, 8월, 10월, 12월 (7개)
- **건너뜀**: 2월, 4월, 6월, 9월, 11월 (5개)

### 6.2 30일 매월 반복

- **입력**: 2025-01-30, monthly, endDate: 2025-12-31
- **출력**: 1월, 3월, 4월, 5월, 6월, 7월, 8월, 9월, 10월, 11월, 12월 (11개)
- **건너뜀**: 2월 (1개)

### 6.3 29일 매월 반복 (평년)

- **입력**: 2025-01-29, monthly, endDate: 2025-12-31
- **출력**: 1월 ~ 12월 모두 (12개)
- **건너뜀**: 없음 (2025년은 평년이지만 28일까지는 있음)

### 6.4 윤년 29일 매월 반복

- **입력**: 2024-01-29, monthly, endDate: 2024-12-31
- **출력**: 1월 ~ 12월 모두 (12개)
- **건너뜀**: 없음 (2024년은 윤년이므로 2월 29일 존재)

### 6.5 2월 28일 매월 반복

- **입력**: 2025-02-28, monthly, endDate: 2025-12-31
- **출력**: 2월 ~ 12월 모두 (11개)
- **건너뜀**: 없음 (모든 달이 28일 이상)

---

## 7. 테스트 시나리오 (간략)

### 추가할 테스트

- [ ] 31일 매월 반복: 2월, 4월, 6월, 9월, 11월 건너뜀 (7개 생성)
- [ ] 30일 매월 반복: 2월만 건너뜀 (11개 생성)
- [ ] 29일 매월 반복 (평년): 모든 달 생성 (12개)
- [ ] 28일 매월 반복: 모든 달 생성 (12개)

### 기존 테스트 유지

- [ ] 작업 001의 17개 테스트는 여전히 통과해야 함

---

## 8. 예시

### 예시 1: 31일 매월 반복

**입력**:
```typescript
const baseEvent: EventForm = {
  title: '월급날',
  date: '2025-01-31',
  repeat: {
    type: 'monthly',
    interval: 1,
    endDate: '2025-12-31'
  },
  // ...
};
```

**출력**:
```typescript
[
  { date: '2025-01-31', ... }, // 1월
  // 2월 건너뜀 (28일까지만)
  { date: '2025-03-31', ... }, // 3월
  // 4월 건너뜀 (30일까지만)
  { date: '2025-05-31', ... }, // 5월
  // 6월 건너뜀 (30일까지만)
  { date: '2025-07-31', ... }, // 7월
  { date: '2025-08-31', ... }, // 8월
  // 9월 건너뜀 (30일까지만)
  { date: '2025-10-31', ... }, // 10월
  // 11월 건너뜀 (30일까지만)
  { date: '2025-12-31', ... }, // 12월
]
// 총 7개
```

### 예시 2: 30일 매월 반복

**입력**:
```typescript
const baseEvent: EventForm = {
  title: '회의',
  date: '2025-01-30',
  repeat: {
    type: 'monthly',
    interval: 1,
    endDate: '2025-12-31'
  },
  // ...
};
```

**출력**: 11개 (2월만 건너뜀)

---

## 9. 구현 계획

### Phase 1: getNextOccurrence() 수정

1. monthly 케이스에서 원래 날짜 저장
2. setMonth() 후 날짜 비교
3. 날짜가 다르면 다음 유효한 달 찾기
4. 재귀 호출로 반복

### Phase 2: 테스트 추가

5. 31일 매월 반복 테스트
6. 30일, 29일, 28일 케이스 테스트
7. 기존 테스트 통과 확인

---

## 10. 다음 작업과의 관계

- **작업 001**: 완료 (기본 반복 생성 로직)
- **작업 002**: 현재 (31일 매월 반복)
- **작업 003**: 다음 (윤년 2월 29일 매년 반복)

작업 002는 **monthly** 반복에만 영향을 줍니다.
작업 003은 **yearly** 반복에 영향을 줍니다.

---

## 11. 주의사항

### JavaScript Date 동작

```javascript
const date = new Date('2025-01-31');
date.setMonth(1); // 2월 = 1
console.log(date); // 2025-02-28 (자동 조정!)
```

JavaScript는 유효하지 않은 날짜를 자동으로 조정합니다. 이를 감지하여 건너뛰기 로직을 구현해야 합니다.

### 무한 루프 방지

재귀 호출을 사용하는 경우, 무한 루프를 방지하기 위해 최대 반복 횟수를 설정하거나, effectiveEndDate를 초과하면 null을 반환해야 합니다.
